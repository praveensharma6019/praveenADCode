@using Sitecore
@using Sitecore.Foundation.SitecoreExtensions.Extensions
@using Sitecore.Data.Fields
@using Sitecore.Data.Items
@using Sitecore.Foundation.Assets
@using Sitecore.Foundation.Assets.Models
@using Sitecore.Foundation.Assets.Services
@using Sitecore.ExperienceForms.Mvc.Html
@using Sitecore.Foundation.Dictionary.Extensions
@using Sitecore.Mvc
@using Sitecore.AdaniGreenTalks.Website
@using AdaniGreenTalks = Sitecore.AdaniGreenTalks.Website
@using System.Linq;
@using System.Globalization;

@model Sitecore.Mvc.Presentation.RenderingModel
@{
    var datasource = Sitecore.Mvc.Presentation.RenderingContext.Current?.Rendering?.DataSource;
    Item model = Sitecore.Foundation.SitecoreExtensions.Extensions.ItemExtensions.getItem(datasource);
    string imgurl = "#";
    string altText = string.Empty;
    var storytemplatedid = AdaniGreenTalks.Templates.StoryTemplate.ID;
    var childlist = new List<Item>();
    string linkurl = "javascript:void(0)";
    InternalLinkField linkField = model.Fields[Constant.parentitem];
    Item parentitem = linkField?.TargetItem;
    var i = 0;
    List<string> regyear = new List<string>();
    var flag = 0;
}
@if (parentitem != null)
{
    if (parentitem.HasChildren)
    {
        childlist = parentitem.GetChildren().Where(c => c.TemplateID == storytemplatedid).OrderByDescending(x => x.Fields["Date"].Value).ToList();
        var latestYear = "";
        var latestYearChildItem = childlist.FirstOrDefault();
        var latestYearChildDate = latestYearChildItem.Fields["Date"].Value;
        var formatedDate = DateTime.ParseExact(latestYearChildDate, "yyyyMMdd'T'HHmmss'Z'", CultureInfo.InvariantCulture);
        latestYear = formatedDate.ToString("yyyy");
        if (childlist != null)
        {
            <div class="goal-stories">
                <div class="container">
                    <div class="heading">
                        <h2>@Html.Sitecore().Field(Constant.Title, model)</h2>
                        <div class="f-wrap">
                            <div class="left">
                                <p class="explore-sub">@Html.Sitecore().Field(Constant.Description, model)</p>
                            </div>
                            <div class="right">
                                <div class="filter-wrap">
                                    <div class="sort">Sort By: <span>@latestYear</span></div>
                                    <ul>
                                        <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                                            <path d="M25 27c.675 0 1.222.544 1.222 1.214v8.563h8.564c.628 0 1.146.478 1.208 1.097L36 38c0 .675-.544 1.222-1.214 1.222h-8.564v8.564c0 .628-.477 1.146-1.096 1.208L25 49a1.218 1.218 0 0 1-1.222-1.214l-.001-8.564h-8.563a1.214 1.214 0 0 1-1.208-1.096L14 38c0-.675.544-1.222 1.214-1.222l8.563-.001v-8.563c0-.628.478-1.146 1.097-1.208L25 27z" style="mix-blend-mode:multiply" transform="rotate(-45 -18.006 42.814)" fill="#555" fill-rule="evenodd"></path>
                                        </svg>
                                        <h4 style="display: none;">Sort By</h4>
                                        @foreach (var child in childlist)
                                        {
                                            var completedate = child.Fields["Date"].Value;
                                            var formatedcompletedate = DateTime.ParseExact(completedate, "yyyyMMdd'T'HHmmss'Z'", CultureInfo.InvariantCulture);
                                            var year = formatedcompletedate.ToString("yyyy");

                                            if (i == 0)
                                            {
                                                regyear.Add(year);
                                                <li data-title="year-@year">@year</li>
                                            }
                                            else
                                            {
                                                foreach (var appendyear in regyear)
                                                {

                                                    if (appendyear == year)
                                                    {
                                                        flag++;
                                                        break;
                                                    }
                                                }
                                                if (flag == 0)
                                                {
                                                    regyear.Add(year);
                                                    <li data-title="year-@year">@year</li>
                                                }
                                                else
                                                {
                                                    flag = 0;
                                                }
                                            }
                                            i++;
                                        }
                                    </ul>
                                </div>
                                <div class="filter-overLay"></div>
                            </div>
                        </div>
                    </div>

                    <div class="cm-story-wrap">
                        @foreach (var selectedYear in regyear)
                        {
                            if (selectedYear == latestYear)
                            {
                                <div class="story-cards" data-name="year-@selectedYear">
                                    @{
                                        var selectedYearChildList = childlist.Where(x => x.Fields["Date"].Value.Contains(selectedYear));
                                    }
                                    @foreach (Item child in selectedYearChildList)
                                    {
                                        if (child.TemplateID == storytemplatedid)
                                        {
                                            Sitecore.Data.Fields.LinkField linkvalue = child.Fields[Constant.LinkUrl];
                                            if (linkvalue != null)
                                            {
                                                linkurl = linkvalue.GetFriendlyUrl();
                                            }
                                            Sitecore.Data.Fields.ImageField imgField = ((Sitecore.Data.Fields.ImageField)child.Fields[Constant.thumbnail]);
                                            if (imgField != null && imgField.MediaItem != null)
                                            {
                                                imgurl = Sitecore.Resources.Media.MediaManager.GetMediaUrl(imgField.MediaItem);
                                                altText = imgField.Alt;
                                            }
                                            <div class="single-card marg-btm">
                                                <a href="@linkurl">
                                                    <div class="card-img-container">
                                                        <img src="@imgurl" alt="@altText" />
                                                    </div>
                                                    <div class="desc">
                                                        <h3>@Html.Sitecore().Field(Constant.Title, child)</h3>
                                                        <p>@Html.Sitecore().Field(Constant.Summary, child)</p>
                                                        <span class="stories-know-more">Explore</span>
                                                    </div>
                                                </a>
                                            </div>
                                        }
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="story-cards" data-name="year-@selectedYear" style="display:none">
                                    @{
                                        var selectedYearChildList = childlist.Where(x => x.Fields["Date"].Value.Contains(selectedYear));
                                    }
                                    @foreach (Item child in selectedYearChildList)
                                    {
                                        if (child.TemplateID == storytemplatedid)
                                        {
                                            Sitecore.Data.Fields.LinkField linkvalue = child.Fields[Constant.LinkUrl];
                                            if (linkvalue != null)
                                            {
                                                linkurl = linkvalue.GetFriendlyUrl();
                                            }
                                            Sitecore.Data.Fields.ImageField imgField = ((Sitecore.Data.Fields.ImageField)child.Fields[Constant.thumbnail]);
                                            if (imgField != null && imgField.MediaItem != null)
                                            {
                                                imgurl = Sitecore.Resources.Media.MediaManager.GetMediaUrl(imgField.MediaItem);
                                                altText = imgField.Alt;
                                            }
                                            <div class="single-card marg-btm">
                                                <a href="@linkurl">
                                                    <div class="card-img-container">
                                                        <img src="@imgurl" alt="@altText" />
                                                    </div>
                                                    <div class="desc">
                                                        <h3>@Html.Sitecore().Field(Constant.Title, child)</h3>
                                                        <p>@Html.Sitecore().Field(Constant.Summary, child)</p>
                                                        <span class="stories-know-more">Explore</span>
                                                    </div>
                                                </a>
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        }
    }
}
